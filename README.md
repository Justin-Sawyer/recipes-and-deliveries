<h1 align="center"><a style="color:green" href="">Recipes and Deliveries</a></h1>

<img src="documentation/image-aid/screenshot.png">

This is the website and application for **Recipes***and***Deliveries**, a community driven website and app offering the ability to purchase meal kits, contribute to the repository of recipes available for purchasing as well as to its blog.

While the website is free to use and peruse, certain parts of the site are reserved for account holders. These include:

1. Creating and editing recipes and blog posts
2. Ingredient listings and recipe preparation in user created posts
3. The ability to up-vote (or like) user created recipes

Although community based, the purpose of the website is commercial, thus readers are urged to sign up and order meal kits in order to access all parts of the website.

As an encouragement for users to do so, the user has the possibility of having his or her submitted recipes being added to the database of recipes and earning credits - redeemable against purther purchases - any time that another, different member orders the user's now-added recipe.

# User Experience (UX)
## User stories
### First Time Visitors

1) As a first time visitor, I want at first glance to understand the principle of the site:

	- I want to know that the recipes listed as products are meal kits and that all ingredients are included when I order a kit. Upon receipt of the kit, all I then need to do is follow the cooking instructions.

	- I want to understand about the delivery service and especially about how cold chain and hygiene rules are respected.

	- I want to be made aware about the benefits of using the service, such as the reduction of food waste and any economies I might make through the use of the service.

	- I want to be reassured that wherever possible, local ingredients and suppliers are used, and that all fresh ingredients are traceable.

	- I want the possibility to sign up to the service to access all the features of the website, whether I decide to purchase a recipe kit or not.

2) Upon ordering a recipe kit, I either:

	- Want the possibility of being an "anonymous" user. That is, should I so wish, I ant to be able to order a recipe kit without having to create an account.

	- Want to become a registered user, with my details saved for both making future purchases and for contributing to the growing list of community recipes and blog posts.

### Returning Registered Visitors

1) As a returniing registered visitor, I would like to alert the community of the quality of the recipe box(es) I ordered:

	- I would like to be able to leave comments on the recipe details page.

2) As a registered user, I would like the possibility to:

	- Comment on blog posts and recipes created by other community members.

	- Up-vote community-created recipes that I find particluarly mouth-watering in the hope that these recipes be added to the recipe database.

	- Create and edit my own recipe concoctions and have them voted on by other community members.

	- Delete blog posts and recipes should I need to.

3) Upon making further orders, I wish that the following information be retrieved automatically, so that I do not have to go through the tedium of re-enetering the details:

	- Delivery address

	- Invoice address

	- Email & Telephone details

4) I wish to be able to edit the above details both when I make a purchase and from within my Account page

### Returning "Anonymous" Visitors

1) As a returning anonymous user, I understand that remaining anonymous means just that. However:

	- If I have previously made a purchase, my invoice address and delivery address has been retained for the purpose of invoicing and delivery. I understand that this information is stored by necessity only.

	- Upon returning to the app, I understand that I will be prompted to create an account in order to access all the features of the website, and contribute to the community should I decide to.

### Frequent Registered Visitors

1) As a frequent registered visitor, I will be a participating member of the **Recipes***and***Deliveries** community:

	- I will have made regular orders of Recipe Boxes, and am likely to have created either recipes or blog entries.

	- If I have created recipes and my recipes have been voted as being the most popular of the last month, I will be alerted that this is the case, and I will see my recipe featured on the recipe boxes purchasing page.

2) As a frequent registered visitor who has recipes feautured on the recipe box purchasing page, I will be alerted whenever users order my recipe:

	- I understand that I, myself, have nothing to do except collect the reward (see next point). I understand that **Recipes***and***Deliveries** look after the dispatching of recipe boxes, and that all I have done is create the recipe itself.

	- I understand that with each user order of the recipe I created, then I will be given a credit that is redeemable against any future orders I may make on the **Recipes***and***Deliveries** website.

	- I can see a tally of the total orders of my recipe on my User Account page. If I wish, I have the option of being alerted via email whenever other users order one of my recipes.

### Frequent Anonymous Visitors

1) I have a good understanding of the functionality of the site, but have chosen for whatever reason to remain anonymous:

	- I accept that doing so means that some part of the site will remain inacessible to me until I decide to register.

	- If I do decide to register, I get full access to the site, but am not obligated to contribute

## Professionals and Aspiring Chefs

**Recipes***and***Deliveries** has the possibility of centralising the multitute of recipe websites that can be found online.

Just as regular users can earn credits when other users order one of their recipes, **Recipes***and***Deliveries** could be a place that hghlights up and coming talents. Once a professional, accredited chef signs on to the service, **Recipes***and***Deliveries** could be a place where said chef might make an income. For the professional, in other words, there could be a small monetary reward instead of a credit whenever a user orders a professional's recipes. 

## Design
### Overall Colour Scheme
		
The project uses a simple design, with colours that are designed to make the end user either think of food or are intuitive in what their purpose is. 

Thus, green is the natural choice for its primary colour. Green is the colour of both most vegetables and most herbs, and is universally known as "Go". Thus the user knows that generally speaking, clicking something green will take the user there. Equally, if the user is registered and wants to contribute to the community, this green signifies "create".

The green is contrasted with brown, which makes the end user think of the warmth of spice and spice mixtures. The brown chosen - the colour of cinnamon - is almost amber, which makes the user think of preparing, just as the amber light in traffic signals tells the driver to prepare to go. Thus, where this cinnamon colour is used, the user knows to either prepare to edit a recipe or the user's Account details.

Where red is used, the user knows this as a "stop", just as the red in traffic signals does. Thus, when red is used in the "store", it means "cancel". Equally, on the community side of the site, red can stand for either deleting something, or anything with a "negative" connotation to it, such as removing a recipe from the user's list of favourite recipes. The exception for this is of course where the recipes are in the list of favourites - the natural colour for a badge containing a heart is of course red.

### Typography
		
Taste is of course a very evocative sense. For this reason, the typography of this website is very important. Just as it is almost always possible to tell the quality of a restaurant from looking at the styling of its menu, this is also the case for the **Recipes***and***Deliveries** website.

It is for this reason that the [Great Vibes](https://fonts.google.com/specimen/Great+Vibes) font has been chosen for headlines and slogans. The font is at once clean and flowing while also being elegant - just as a visit to a classy restaurant should be.

Otherwise, for general text and banners, [Raleway](https://fonts.google.com/specimen/Raleway?query=raleway) has been chosen. A simple sans-serif, it has been chosen for both its clarity and for the nuance behind its name: Raleway resembles the font styles used in transport hubs such as railway stations. Going to the station implies taking a journey, and people often talk of going on a "culinary adventure" - a journey in its own right. Raleway, then, is the perfect base font for **Recipes***and***Deliveries**.

### Imagery
#### Recipe Box Photos
		
Imagery is extremely important on any website, but especially so on commercial, food oriented ones: Nothing makes the tongue water more than seeing a beautifully presented meal. The images inspire the end user to both try the recipe, and more importantly, join the community and become an active member.

The "all recipe boxes" page is a showcase for all the recipe boxes that are available for order, and each is represented by an image and star rating (see Testing, below).

Ideally, each individual recipe box page should have the final end meal for that recipe as its banner image. However, this is a community website, where users are encouraged to participate by adding their own recipes to that section of the site and eventaully to the repository. 

Thus, when uploading a recipe to the website, the community member is prompted to add an image of the prepared meal. 

For plaigirism reasons, the user is only given the option of uploading images from their device, rather than having the option to search online for images. The user is also asked to provide an image credit.

However, it is fair to say that not everyone knows how to take a good photo, just as not everyone knows how to cook. 

It is for this reason that images on the Recipe Box pages might have been either professionally sourced, or created by the site owners themselves. It is for this reason that images are credited.

#### Backgrounds

Again, to reinforce the desire for food - and thus purchasing a recips box -  an image of fresh produce has been used as the background rather than a plain white one. Care has been taken to ensure that banner or headline text is not rendered ilisible by the background image. All "generic" screen sizes have been tested (ie, xs (mobile), sm (tablet portrait), md (tablet landscape, lg (desktop) and xl) but there may be certain "in-between" screen resolutions where this text may be obscured by the background image.

#### Recipe Box Cards

Recipe boxes are presented as cards with white backgrounds. Thus each recipe box available for order is subtly highlighted against the screen background. White has been chosen to once again reinforce the idea of "fresh, clean and hygienic".

## Wireframes

[Landing Page, highlighting the commercial service](https://github.com/Justin-Sawyer/recipes_and_deliveries/blob/master/documentation/wireframes/1-recipes.png)

[Landing Page, highlighting the community aspect](https://github.com/Justin-Sawyer/recipes_and_deliveries/blob/master/documentation/wireframes/2-deliveries.png)

[Commerce, all Recipe Boxes](https://github.com/Justin-Sawyer/recipes_and_deliveries/blob/master/documentation/wireframes/3-all-recipe-boxes.png)

[Commerce, individual Recipe Box](https://github.com/Justin-Sawyer/recipes_and_deliveries/blob/master/documentation/wireframes/4-recipe-box.png)

[Commerce, shopping bag](https://github.com/Justin-Sawyer/recipes_and_deliveries/blob/master/documentation/wireframes/5-bag.png)

[Commerce, checkout](https://github.com/Justin-Sawyer/recipes_and_deliveries/blob/master/documentation/wireframes/6-checkout.png)

[Community, blog](https://github.com/Justin-Sawyer/recipes_and_deliveries/blob/master/documentation/wireframes/7-community-blog.png)

[Community, individual blog entry](https://github.com/Justin-Sawyer/recipes_and_deliveries/blob/master/documentation/wireframes/8-community-blog-entry.png)

[Community, add edit or delete blog post](https://github.com/Justin-Sawyer/recipes_and_deliveries/blob/master/documentation/wireframes/9-community-blog-add-edit-delete-post.png)

[Community, recipes](https://github.com/Justin-Sawyer/recipes_and_deliveries/blob/master/documentation/wireframes/10-community-recipes.png)

[Community, individual recipe entry](https://github.com/Justin-Sawyer/recipes_and_deliveries/blob/master/documentation/wireframes/11-community-recipe-entry.png)

[Community, add edit or delete recipe post](https://github.com/Justin-Sawyer/recipes_and_deliveries/blob/master/documentation/wireframes/12-community-recipes-add-edit-delete-recipe.png)

## Features

This website is fully responsive and interactive.

## Technologies Used
### Languages
	
[HTML5](https://en.wikipedia.org/wiki/HTML5)

[CSS](https://en.wikipedia.org/wiki/CSS)

[JavaScript](https://en.wikipedia.org/wiki/JavaScript)

[jQuery](https://en.wikipedia.org/wiki/JQuery)

[JSON](https://en.wikipedia.org/wiki/JSON)

[Python](https://en.wikipedia.org/wiki/Python_(programming_language))

### Frameworks, Libraries & Programs

[Markdown Editor](https://iwaki.info/markdown-editor-mac/en/index.html) was used for the writing of this README.md file.

[Balsamiq](https://balsamiq.com) was used for the creation of the wireframes.

[Git](https://git-scm.com) was used for version control.

[GitPod](https://www.gitpod.io/) was used as the writing tool. 

[GitHub](https://www.gitpod.io/) was used as the repository for the files within this project.

[Heroku](https://www.heroku.com/home) was used for hosting this project.

[Amazon Web Services](https://aws.amazon.com/) was used for the hosting of static files.

[Preview for Mac](https://support.apple.com/en-gb/guide/preview/welcome/mac) was used for image sizing (height and width), where images are the author's own or were posted by the author.

[Squash](https://www.realmacsoftware.com/squash/) was used to lighten the weight of image files, where images are the author's own or were posted by the author.

[Bootstrap](https://getbootstrap.com/) forms the vast majority of the formatting code, such as the grid system, containers, buttons, icons etc. It has been heavily modified by the author of this project to suit the website's needs.

[Font Awesome v4.7.0](https://fontawesome.com/v4.7.0/) was used for the social icons used on this site, since they are so easily recognisable.

[Google Fonts](https://fonts.google.com/) was used for the typography.

[Django](https://www.djangoproject.com/) is the framework upon which this website is built.

[django-allauth](https://django-allauth.readthedocs.io/en/latest/index.html) was used for user authentication.

[Stripe](https://stripe.com/en-gb) was used for the payment system.

[Pexels](https://www.pexels.com/) was used to source the Recipe Box card images, unless otherwise stated.

## Testing
### Code Validation

This website was tested using the following tools:

1. [W3C HTML](https://validator.w3.org/) was used to verify the HTML code:
	* [Results]()

2. [W3C CSS](https://jigsaw.w3.org/css-validator/) was used to ensure there were no CSS code errors in this project:
	* [Results]()

3. [JSHint](https://jshint.com/) was used for the verification of the JavaScript:
	* [Results]()

4. [Python Validator](http://pep8online.com/) was used for verification of all Python code:
	* [Results]()

5. Google Chrome's Dev Tool was used extensively while writing this website.

6. The [Lighthouse plugin for Google Chrome](https://chrome.google.com/webstore/detail/lighthouse/blipmdconlkpinefehnmjammfjpmpbjk?hl) was used for speed checking and "tweaking" settings for maximal optimisation for web deployment.
	* [Results (pdf files)]()

### Testing User Stories


### Testing Functionality

This project has been a labour of love and has taken many, many hours to complete. Code was tested exhaustively to check for errors and bugs:


#### Star Ratings

The developer wrote a little JavaScript script to display star icons according to the Recipe Box rating. Thus, if a Recipe Box had a rating of 3/5, three amber stars would be displayed.

The developer first wrote this script for individual Recipe Boxes. Thus, when a user clicks an individual Recipe Box in the All Recipe Boxes page, the user is taken to the page for that Recipe Box. Here, the user is presented with the Recipe Box name, its price, the categories to which it belongs, and its star rating (plus its rating value out of 5):

<img src="documentation/screenshots/testing/star-rating-individual-box.png">

The script:

```
let rate = document.getElementById('rating').innerText;
let icon = document.getElementById('rating').innerHTML;

let rateStr = rate.split('.')[0];
let rateInt = parseInt(rateStr);
let iconStr = icon.split(rate)[0];
for (let i=0; i<rateInt; i++) {
	newRating = document.querySelector('#rating').innerHTML += iconStr;
}

let stars = newRating.split('5')[1];
$('#rating').html(`${stars} ${rate}`);
```

where `#rating` is 

```
<small class="text-muted" id="rating">
    <i class='text-amber fas fa-star mr-1'></i>
    {{ product.rating }} / 5
</small>
```

As can be seen, although the above code works, it is not very "succinct". The first two lines of the code are essentially calling different parts of the same code string. 

Further, the loop is adding to the existing code, essentially duplicating code needlesly. Thus, if the `rateInt` value is 3, the code in the HTML becomes 

```
<i class='text-amber fas fa-star mr-1'></i>
{{ product.rating }} / 5
<i class='text-amber fas fa-star mr-1'></i>
<i class='text-amber fas fa-star mr-1'></i>
<i class='text-amber fas fa-star mr-1'></i>
```

To counter this, a new variable `stars` is created to take the split value of the above string from the `5` onwards (ie, the three trailing icons).

Then, in the last line of the script, the existing HTML string is removed entirely and replaced with `stars` (the three trailing icons) and `rate`(the rating out of 5).

At this point, the developer was not concerned with the elegance of the script, seeking just a proof of concept which he could use for the All Recipe Boxes page.

The developer knew that he would have to adapt this code to classes rather than ids, firstly because the HTML would show an error if each element had an id of `rating` and secondly because if each element being questioned had the same id value, then any code written to get the Integer value of the rating would only return the last of those values.

Thus the developer adapted the HTML to include a class `rating` and for each of the elements in that class to have an id of `rating_{{ product.id }}`:

```
<p class="text-muted rating" id="rating_{{ product.id }}">
    <small>
        <i class='text-amber fas fa-star mr-1'></i>
        {{ product.rating }} / 5
    </small>
</p>
```

From here, the developer was able to extract each `{{ product.rating }}` and split them to their Integer values as array entries, and each id value and create an array from these id values:

```
// Create array of Integer values of {{ product.rating }}
let ratings = $('.rating').map(function(){
        return $(this).text().split('.')[0];
    }).get().map(Number);
// (ex: ratings = [4, 4, 5, 3, 4, 4])

// create array of .rating individual ids
let rating = $('.rating').map(function(){
        return $(this).attr('id');
    }).get()
// (ex: rating = ['rating_1', 'rating_2', 'rating_3', 'rating_4', 'rating_5', 'rating_6']
```

The problem the developer was now confronted with was the dynamic nature of these values. The developer knew he could write a line of code for each id, however as the site grows the developer would need to keep adding code for each recipe box element added to the site. 

The developer turned towards his Python code, to see whether he could dynamically retrieve each Integer rating value from within the all_products function.

```
def all_products(request):
    """ A view to show all products, including sorting and search queries """

    products = Product.objects.all().order_by('-pk')
    query = None
    categories = None
    sort = None
    direction = None
    if request.GET:
        if 'sort' in request.GET:
            sortkey = request.GET['sort']
            sort = sortkey
            if sortkey == 'name':
                sortkey = 'lower_name'
                products = products.annotate(lower_name=Lower('name'))
            if sortkey == 'category':
                sortkey = 'category__name'

            if 'direction' in request.GET:
                direction = request.GET['direction']
                if direction == 'desc':
                    sortkey = f'-{sortkey}'
            products = products.order_by(sortkey)

        if 'category' in request.GET:
            categories = request.GET['category'].split(',')
            products = products.filter(category__name__in=categories)
            categories = Category.objects.filter(name__in=categories)

        if 'q' in request.GET:
            query = request.GET['q']
            if not query:
                messages.error(request,
                               "You didn't enter any search criteria!")
                return redirect(reverse('products'))

            queries = Q(name__icontains=query) | Q(
                description__icontains=query)
            products = products.filter(queries)

    current_sorting = f'{sort}_{direction}'

    context = {
        'products': products,
        'search_term': query,
        'current_categories': categories,
        'current_sorting': current_sorting,
    }

    return render(request, 'products/products.html', context)
```

The developer wondered whether adding 

```
'product': product,
'ratings': range(int(ratings)),
```

to the `context`, getting the rating values from the Product model

`ratings = products.filter(rating='rating')`

 and using template logic in the HTML

```
{% for r in rating %}
	<i class='text-amber fas fa-star mr-1'></i>
{% endfor %}
```

might be the answer. 

The developer tried many variations of this code, but with each try was always confronted with templating errors.

The developer turned back to the JavaScript. Still the problem was the same: How to get dynamically generated id values and use those values to insert code?

Firstly, the developer knew that he would have to include the `{{ product.rating }}` within the HTML itself. Otherwise the JavaScript would have no value to get.

He knew also that he would have to loop through each rating value, if a product had a rating. Thus, he adapted the HTML code as follows:

```
{% if product.rating %}
    <p class="text-muted rating" id="rating_{{ product.id }}">
        <small>
            {% for r in rating %}
                <!-- Star Rating here -->
            {% endfor %}
            {{ product.rating }} / 5
        </small>
    </p>
{% else %}
    <small class="text-muted">No Rating</small>
{% endif %}
```

After much research and trial and error, the developer eventually found a way in the JavaScript to loop through the rating class, assign each individual id's text value of that class to a variable, then override the HTML to display the number of stars according to the Integer value of each item's rating plus its rating value out of 5:

```
let rating = $('.rating').map(function(){
    return $(this).attr('id');
}).get();
// (ex: rating = ['rating_1', 'rating_2', 'rating_3', 'rating_4', 'rating_5', 'rating_6']

for (r of rating) {
    // For each array entry, get its Full Number rating value
    let ratingValueForIcon = $(`#${r}`).text().split('.')[0];
    // For each array entry, get its full text
    let ratingValue = $(`#${r}`).text();
    icon = "<i class='text-amber fas fa-star mr-1'></i>";
    // For each array entry, insert icon repeated by the Full Number rating value and the full text of the rating value
    document.getElementById(r).innerHTML = icon.repeat(`${ratingValueForIcon}`) + ratingValue;
}
```

This had the desired effect: all Recipe Box cards on the "All Recipe Boxes" page now display the approproate number of stars:

<img src="documentation/screenshots/testing/star-rating-all-boxes.png">

From here, the devloper could delete the original JavaScript code from the individual Recipe Box page, add the class `rating` to the rating section of the HTML, then create a separate script file in the `includes` folder and call the script from both the `products.html` template and the individual `product_detail.html` template.



## Back End
### Database Models

#### Products

#### Categories

#### User

#### Blog

#### Recipes

# Deployment


The deployment process listed below assumes that you have
1. A GitHub Account
2. A Heroku Account
3. A Stripe Account
4. An Amazon AWS Account 

## Clone this GitHub Repository 


## Deploying to Heroku
### Create the app at heroku.com 
1. Create app and give it a name, then select your region.
2. Add Posrtgres to the app by searching for it from the “Resources” tab
3. From the settings tab, click “Reveal Config Vars” and copy down the whole DATABASE_URL value

    `postgres://…`

4. Install the following in the CLI (terminal) in order to use Postgres

    ```
	pip3 install dj_database_url
    pip3 install psycopg2-binary
	```

5. Freeze the requirements

    `pip3 freeze > requirements.txt`

### Enable the postgres database in app/settings.py
1. Import dj_database_url in settings.py

    `import dj_database_url`

2. Comment out the default DATABASES configuration, replace the configuration with a call to dj_database_url.parse(), populating the string with the copied DATABASE_URL variable from above

	```
	# DATABASES = {
	#    'default': {
	#        'ENGINE': 'django.db.backends.sqlite3',
	#        'NAME': BASE_DIR / 'db.sqlite3',
	#    }
	# }

	DATABASES = {
    	'default': dj_database_url.parse('postgres://...')
	}
	```

### Migrating data

1. Run migrations and migrate database to Postgres from the CLI

	```
	python3 manage.py showmigrations
	python3 manage.py migrate
	```

2. Import database data (found in the fixtures folder of the app) via the CLI ensuring to import the dependency before the dependants (eg, categories before products)

	```
	python3 manage.py loaddata categories
	python3 manage.py loaddata products
	```

3. Assign superuser from the CLI, and answer prompts to create superuser name, email account and password

	`python3 manage.py createsuperuser`

4. Uncomment (restore) the default DATABASES configuration and remove the dj_database_url.parse(‘postgres://…') version to ensure the database url does not appear in version control

	```
	DATABASES = {
    	'default': {
        	'ENGINE': 'django.db.backends.sqlite3',
        	'NAME': BASE_DIR / 'db.sqlite3',
    	}
	}
	```

5. Commit all changes in the CLI

	```
	git add .
	git commit -m ‘Heroku and postgres set up, data migrated’
	git push
	```

### Using the environment for the DATABASES dictionary

1. Setting os.environ in app/settings.py to use postgres on the live site and sqlite when in development mode. Ensure that the `postges://...` value is NOT inserted in `dj_database_url.parse()`, but that `os.environ.get('DATABASE_URL'))` is entered as the value

	```
	if 'DATABASE_URL' in os.environ:
    	DATABASES = {
        	'default': dj_database_url.parse(os.environ.get('DATABASE_URL'))
    	}
	else:
    	DATABASES = {
        	'default': {
            	'ENGINE': 'django.db.backends.sqlite3',
            	'NAME': BASE_DIR / 'db.sqlite3',
        	}
    	}
	```
2. Install gunicorn via the CLI to act as webserver

	`pip3 install gunicorn`

3. Freeze requirements

	`pip3 freeze > requirements.txt`

### Create a web dyno to run gunicorn and serve the app

1. At system level, create the Procfile and add the following code to create the web dyno

	`web: gunicorn <app_name>.wsgi:application`

### Log in to heroku through the CLI and disable static file collection

1. Log in to heroku then follow prompts

	`heroku login -i`

2. Disable static collection

	Note that this process will clear images and styling from the finished app. These will be restored in the section 'Storing static files and images' (below)

	`heroku config:set DISABLE_COLLECTSTATIC=1`

	Note that if you have more than one heroku app, you will need to specify which app to disable the collection of static on

	`heroku config:set DISABLE_COLLECTSTATIC=1 app name-of-your-app`

### Allow heroku and GitHub (for development) to host the live site

1. In settings.py add the app to ALLOWED_HOSTS

	`ALLOWED_HOSTS = ['name-of-your-app.herokuapp.com', 'localhost']`

2. Commit and push changes to GitHub from the CLI

	```
	git add .
	git commit -m ‘Deployment to heroku’
	git push
	```

3. Initialize the heroku git remote

	`heroku git:remote -a name-of-your-app`

4. Push to heroku

	`git push heroku master`

5. Once the CLI has verified the deployment (`Verifying deploy... done. To https://git.heroku.com/name-of-your-app.git`), navigate to the app in the browser. If all is well, the site will be live, albeit with the styling removed. If not, you can use the command given on the page to check the logs

### Set up automatic deployment

1. Connect to GitHub fropm the "Deploy" tab in the app's heroku.com dashboard

2. Click enable automatic deploys

### Set SECRET_KEY variables in heroku and GitPod

1. For each of the above, generate a secret key (for example, [from here](https://miniwebtool.com/django-secret-key-generator/))

2. In the heroku dashboard naigate to the settings tab and add `SECRET_KEY` and its value to the Config Vars

3. In the GitPod settings ["variables" tab](https://gitpod.io/variables), repeat the above using a new value for the key

4. In app/settings.py replace the secret key setting with a call to get the key from the environment and use an empty string as a default

	`SECRET_KEY = os.environ.get('SECRET_KEY', '')`

### Debug settings

1. Set debug to be true only if there's a variable called development in the environment

	`DEBUG = 'DEVELOPMENT' in os.environ`

### Commit

1. In the CLI, add, commit and push as normal. The commits will be pushed both to GiuHub and heroku

	```
	git add .
	git commit -m ‘Deployment to heroku’
	git push
	```

## Storing static files and images

The app will now be live, but currently shows no styling or images, because `DISABLE_COLLECTSTATIC` is set to `1`. These steps will render the CSS styling and return the images to the live site.

### Create a bucket in Amazon AWS

1. Sign in to your Account [here](https://aws.amazon.com/) as a Root User

2. Search "s3" and then click "Create bucket"

3. Name the bucket to match the heroku app name

4. Select region from dropdown menu

5. Allow all public access by unchecking "Block all public access" and accepting the consequences. This is needed as we want the public to see the product images

6. Click "Create Bucket"

7. Open the bucket by clicking its link

### Bucket Properties

1. From the "Properties" tab, enable static website hosting

2. Input the default values for "Index Document" and "Error document"

3. Click "Save"

### Bucket Permissions

1. Add a Coors configuration to set up the required access between the Heroku app and this s3 bucket and then click "Save"

    ```
    [
      {
          "AllowedHeaders": [
              "Authorization"
          ],
          "AllowedMethods": [
              "GET"
          ],
          "AllowedOrigins": [
              "*"
          ],
          "ExposeHeaders": []
      }
    ]
    ```

2. Select “Policy generator” from the Bucket Policy section to create a security policy for the bucket. A new browser window will open

3. From the new browser window,  select "s3 Bucket Policy" in Step 1

4. Allow all Principals by adding an asterisk (`*`) to the Pricipal input area of Step 2

5. Choose "GetObject" from the Actions dropdown menu

6. From the OTHER browser window, copy the Bucket ARN and paste this into the "Amazon Resource Name (ARN)" box of the new window

7. Click "Add Statement" then in Step 3, click "Generate Policy"

8. Cope the Policy JSON Document into the Bucket Policy of the first window

9. Allow access to all resources in the bucket by adding a slash and an asterisk (`/*`) to the end of the Resource key

	`"Resource": "arn:(etc)/*",`

10. Click "Save Changes"

11. Set the Access control list object's permission for Everyone under the Public Access section

12. Accept that you acknowledge the effects

13. Click "Save Changes"

## Identity and Access Management

### Creating AWS Groups, Policies and Users in order to access the images and static files

1. From the "Services" dropdown of [aws.amazon.com](aws.amazon.com), search and select "IAM"

### Creating the User Group

1. Select "User Groups" from the dashboard

2. Click "Create group" and name the group. User groups manage permissions, so name the User Group accordingly (for example, `manage-name-of-your-app`)

3. Click "Save changes"

### Creating the Policy

1. Select "Policies" from the dashboard

2. Click "Create polocy" 

3. Click the "JSON" tab, then click "Import managed policy"

4. Search "s3" then select "AmazonS3FullAccess"

5. Click "Import"

6. Since access is only required for this bucket, change the JSON `"Resource": ` key from an asterick to the below by copying the Bucket ARN (see Bucket Permissions, above) and pasting it into the JSON

	```
	"Resource": [
                "arn:(etc)",
                "arn:(etc)/*"
                ]
	```
7. Click "Next" and add tags if desired

8. Click next to review and name the policy

	`name-of-you-app-policy`

9. Give the policy a description

	`Access to S3 bucket for name-of-your-app static files`

10. Click "Create policy"

### Attaching the Policy to the User Group

1. Select User Groups from the dashboard

2. Select the relevant group name

3. In the "Permissions" tab, click "Add permissions" and the choose "Attach policy" from the menu

4. Select the required policy then click "Add policy"

### Creating the User for the User Group

1. Select "Users" from the dashboard

2. Click "Add users" and add a user name, for example `name-of-you-app-staticfiles-user`

3. Select "Programmatic access" as the AWS access type

4. Click "Next: Permissions"

5. Select the relevant group to add the user to

6. Click "Next: Tags" then add tags if desired

7. Click "Next: Review"

8. Click "Create user"

9. Click "Download .csv" to download the attached csv file. 

	<span style="color:red">**It is very important to download and save this file as it cannot be re-downloaded at a later time!**</span>

## Configure Django to connect to S3

1. In the CLI of the app, install `boto-3` and `django-storages`

	```
	pip3 install boto3
	pip3 install django-storages
	```
2. Freeze the requirements

	`pip3 freeze > requirements.txt`

3. Add `storages` to the list of `INSTALLED_APPS` in app/settings.py

### Add settings to settings.py so that the live (deployed to heroku) site connects to S3.

Since the styling and images are available within the app (thanks to the use of the inbuilt sqlite database), they will always be visible while in development. Thus, it is ONLY the live deployed site that needs to connect to S3

1. Add relevant `if` statement: "if there is a vairable called USE_AWS in the environment, then connect to AWS"

	```
	if 'USE_AWS' in os.environ:
    	# Bucket config
    	AWS_STORAGE_BUCKET_NAME = 'name-of-your-app'
    	AWS_S3_REGION_NAME = '(the region choen when setting up AWS)'
    	AWS_ACCESS_KEY_ID = os.environ.get('AWS_ACCESS_KEY_ID')
    	AWS_SECRET_ACCESS_KEY = os.environ.get('AWS_SECRET_ACCESS_KEY')
	```

	<span style="color:red">**Again, it is very important you keep these last two keys' values secret as if they end up in version control someone could use them to store or move data through your S3 bucket and Amazon would bill your credit card for it**</span>

### Adding the AWS keys to heroku's Config Vars

1. In the heroku.com dashboard create two new variables and populate them with the relevant values from the downloaded .csv file

	`AWS_ACCESS_KEY_ID` = Access key ID value

	`AWS_SECRET_ACCESS_KEY` = Secret access key value

2. Add `USE_AWS` to the Config Vars in heroku and set its value to `True`

3. Remove the `DISABLE_COLLECTSTATIC` variable so that when deploying to Heroku, Django will collect static files automatically and upload them to S3

### Tell django where static files will come from in production

1. In app/settings.py, add another vairable to the `if 'USE_AWS' in os.environ:` statement

	`AWS_S3_CUSTOM_DOMAIN = f'{AWS_STORAGE_BUCKET_NAME}.s3.amazonaws.com'`

2. At system level, create a new file called `custom_storages.py`

3. In this file, import the following

	```
	from django.conf import settings
	from storages.backends.s3boto3 import S3Boto3Storage
	```

4. Create the following custom Classes:

	```
	class StaticStorage(S3Boto3Storage):
    	location = settings.STATICFILES_LOCATION

	class MediaStorage(S3Boto3Storage):
    	location = settings.MEDIAFILES_LOCATION
	```

5. Tell app/settings.py that for static file storage it use the above custom storage Classes and that the location it should save static files to is in a folder called static. Inside the same `if USE_AWS in os.environ:` statement, add

	```
	STATICFILES_STORAGE = 'custom_storages.StaticStorage'
    STATICFILES_LOCATION = 'static'
    DEFAULT_FILE_STORAGE = 'custom_storages.MediaStorage'
    MEDIAFILES_LOCATION = 'media'
	```

6. In the same `if` statement, override and explicitly set the URLs for static and media files using the custom domain and the new locations

	```
	STATIC_URL = f'https://{AWS_S3_CUSTOM_DOMAIN}/{STATICFILES_LOCATION}/'
    MEDIA_URL = f'https://{AWS_S3_CUSTOM_DOMAIN}/{MEDIAFILES_LOCATION}/'








































